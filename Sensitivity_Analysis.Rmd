---
title: "Sensitivity Analysis"
author: "Robert Saldivar and Madeline Gorchels"
date: "4/22/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}

library(tidyverse)
library(sensitivity)
library(pse)
library(gridExtra)


```

```{r}
# Sensitivity Analysis
# All parameters varied

source("Almond_Yield.R")


# Lets consider all parameters....
factors = c("min_temp_coeff", "min_temp_coeff2", "precip_coeff", "precip_coeff2", "intercept")

# Decide How many parameter sets to run
nsets=500


#Setting up standard deviation of 20%
sd1 = 0.015*0.2
sd2 = 0.0046*0.2
sd3 = 0.07*0.2
sd4 = 0.0043*0.2
sd5 = 0.28*0.2

# choose distributions for parameters - 
q = c("qnorm", "qnorm", "qnorm", "qnorm", "qnorm")
q.arg = list(list(mean=-0.015,sd=sd1), list(mean=-0.0046, sd=sd2), list(mean=-0.07, sd=sd3), list(mean=0.0043, sd=sd4), list(mean=0.28, sd=sd5))

# generate samples from LHS
sens_almond = LHS(NULL,factors,nsets,q,q.arg)
sens_pars = get.data(sens_almond)
head(sens_pars)

# now run the model for each pai of samples
# first create a data structure to store results
sens_results = matrix(nrow=nsets, ncol=5)

# read in the input data
SB=read_csv("climate.csv")
clim= SB

#apply our function to the sensativity parameters 
tmp= mapply(FUN=Almond_Yield,Tmincoeff1=sens_pars$Tmincoeff1, Tmincoeff2=sens_pars$Tmincoeff2, MoreArgs=list(clim=clim))
head(tmp)

# use unlist to get a matrix
sens_results = matrix((unlist(tmp)), ncol=2, byrow=TRUE)

colnames(sens_results)=c("maxyield","minyield")

# to take advantage of LHS/pse functions for plotting interesting information we can send results back
sens_almond = pse::tell(sens_almond, t(sens_results), res.names=c("maxyield","minyield"))
pse::plotscatter(sens_almond, col="blue", cex=5)

pse::plotprcc(sens_almond)
sens_almond$prcc

# we can also plot results in interesting ways
# turn sens_results into a data frame - easier access to R plotting functions

sens_results = as.data.frame(sens_results)
ggplot(sens_results, aes(minyield, maxyield))+geom_point()+labs(y="Max Yield (as anomoly)", "Min Yield (as anomoly")


# add uncertainty bounds on our estimates
tmp = sens_results %>% gather(value="value", key="yield")
ggplot(tmp, aes(yield, value, col=yield))+geom_boxplot()+labs(y="Yield (as anomoly)")

# notice the difference
ggplot(tmp, aes(yield, value, col=yield))+geom_boxplot()+labs(y="Yield (as anomoly)")+facet_wrap(~yield, scales="free")

```

```{r}
# Rank and Graph of Sensitivity Analysis


```


```{r}
# Sensitivity Analysis using LHS


```

```{r}
# Rank and Graph of LHS
```


```{r}
# Sensitivity Analysis Using Sobel Method

```

```{r}
# Rank and Graph of Sobel Method
```


```{r}
# Sensitivity Analysis using twice as many parameters


```

